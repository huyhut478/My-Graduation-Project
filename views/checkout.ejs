<div class="checkout-container">
  <h1>X√°c nh·∫≠n thanh to√°n</h1>
  
  <% if (insufficient && insufficient.length) { %>
    <div class="flash error">
      <strong>‚ö†Ô∏è L·ªói t·ªìn kho:</strong> Kh√¥ng ƒë·ªß t·ªìn kho cho: <%= insufficient.join(', ') %>
    </div>
  <% } %>
  
  <div class="checkout-grid">
    <div class="checkout-left">
      <div class="checkout-section">
        <h2>üì¶ Th√¥ng tin ƒë∆°n h√†ng</h2>
        <div class="order-items">
          <% Object.values(cart.items || {}).forEach(({product, qty}) => { %>
            <div class="order-item">
              <div class="order-item-info">
                <h4><%= (product && product.title) ? product.title : 'S·∫£n ph·∫©m' %></h4>
                <span class="order-item-qty">S·ªë l∆∞·ª£ng: <%= qty %></span>
              </div>
              <div class="order-item-price">
                <span class="price"><%= (((product && product.price_cents) ? product.price_cents : 0) * qty / 100).toLocaleString('vi-VN',{style:'currency',currency:'VND'}) %></span>
              </div>
            </div>
          <% }) %>
        </div>
      </div>
      
      <div class="checkout-section">
        <h2>üìß Th√¥ng tin nh·∫≠n key</h2>
        <p class="muted">Key s·∫Ω ƒë∆∞·ª£c g·ª≠i qua email: <strong><%= currentUser.email %></strong></p>
        <p class="muted" style="font-size: 14px; margin-top: 8px;">
          üí° Vui l√≤ng ki·ªÉm tra c·∫£ h·ªôp th∆∞ spam n·∫øu kh√¥ng th·∫•y email trong v√†i ph√∫t.
        </p>
      </div>
      
      <div class="checkout-section">
        <h2>üí≥ Ph∆∞∆°ng th·ª©c thanh to√°n</h2>
        <div class="payment-methods">
          <div class="payment-method active" data-method="momo" onclick="selectPaymentMethod('momo')">
            <span class="payment-icon">üì±</span>
            <span>V√≠ ƒëi·ªán t·ª≠ MoMo</span>
            <span class="payment-badge">Thanh to√°n ngay</span>
          </div>
        </div>
        <p class="muted" style="margin-top: 12px; font-size: 14px;">
          üí° Sau khi thanh to√°n th√†nh c√¥ng, key s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã ngay trong trang ƒë∆°n h√†ng c·ªßa b·∫°n.
        </p>
      </div>
    </div>
    
    <div class="checkout-right">
      <div class="checkout-summary">
        <h2>T√≥m t·∫Øt ƒë∆°n h√†ng</h2>
        
        <div class="summary-row">
          <span>T·∫°m t√≠nh:</span>
          <span><%= ((cart.totalCents || 0)/100).toLocaleString('vi-VN',{style:'currency',currency:'VND'}) %></span>
        </div>
        
        <div class="summary-row">
          <span>Ph√≠ v·∫≠n chuy·ªÉn:</span>
          <span style="color: #10b981;">Mi·ªÖn ph√≠</span>
        </div>
        
        <div class="summary-row discount">
          <span>Khuy·∫øn m√£i:</span>
          <span>- 0 VND</span>
        </div>
        
        <div class="summary-row total">
          <span><strong>T·ªïng c·ªông:</strong></span>
          <span class="price"><%= ((cart.totalCents || 0)/100).toLocaleString('vi-VN',{style:'currency',currency:'VND'}) %></span>
        </div>
        
        <form id="checkout-form" class="checkout-form">
          <input type="hidden" name="payment_method" id="payment-method" value="momo" />
          <button type="submit" class="btn primary large checkout-btn" id="checkout-btn" <%= (insufficient && insufficient.length) ? 'disabled' : '' %>>
            <span id="checkout-icon">üì±</span>
            <span id="checkout-text">Thanh to√°n b·∫±ng MoMo</span>
          </button>
        </form>
        
        <div class="checkout-security">
          <div class="security-item">
            <span>üîí</span>
            <span>Thanh to√°n an to√†n</span>
          </div>
          <div class="security-item">
            <span>üöÄ</span>
            <span>Giao h√†ng nhanh</span>
          </div>
          <div class="security-item">
            <span>üíØ</span>
            <span>ƒê·∫£m b·∫£o ch·∫•t l∆∞·ª£ng</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
.checkout-container {
  max-width: 1200px;
  margin: 0 auto;
}

.checkout-grid {
  display: grid;
  grid-template-columns: 1fr 400px;
  gap: 30px;
  margin-top: 30px;
}

.checkout-section {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 24px;
  margin-bottom: 20px;
}

.checkout-section h2 {
  margin: 0 0 20px 0;
  font-size: 20px;
  color: var(--fg);
  border-bottom: 2px solid var(--green);
  padding-bottom: 10px;
}

.order-items {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.order-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px;
  background: rgba(255, 255, 255, 0.02);
  border: 1px solid var(--border);
  border-radius: 8px;
}

.order-item-info h4 {
  margin: 0 0 6px 0;
  font-size: 16px;
  color: var(--fg);
}

.order-item-qty {
  font-size: 14px;
  color: var(--muted);
}

.order-item-price {
  font-size: 18px;
  font-weight: 600;
}

.payment-methods {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.payment-method {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 16px;
  border: 2px solid var(--border);
  border-radius: 8px;
  background: rgba(255, 255, 255, 0.02);
  transition: all 0.2s;
}

.payment-method.active {
  border-color: var(--green);
  background: rgba(22, 163, 74, 0.1);
}

.payment-icon {
  font-size: 24px;
}

.payment-badge {
  margin-left: auto;
  padding: 4px 12px;
  background: var(--green);
  color: white;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 600;
}

.checkout-summary {
  position: sticky;
  top: 100px;
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 24px;
}

.checkout-summary h2 {
  margin: 0 0 20px 0;
  font-size: 20px;
  color: var(--fg);
}

.summary-row {
  display: flex;
  justify-content: space-between;
  margin-bottom: 12px;
  padding-bottom: 12px;
  border-bottom: 1px solid var(--border);
}

.summary-row.discount {
  color: var(--muted);
  font-size: 14px;
}

.summary-row.total {
  border-bottom: none;
  border-top: 2px solid var(--border);
  padding-top: 12px;
  margin-top: 12px;
  font-size: 20px;
}

.checkout-form {
  margin-top: 24px;
}

.checkout-btn {
  width: 100%;
  padding: 16px;
  font-size: 18px;
  font-weight: 600;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  border-radius: 12px;
  transition: all 0.2s;
}

.checkout-btn:hover:not(:disabled) {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(22, 163, 74, 0.3);
}

.checkout-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.checkout-security {
  margin-top: 20px;
  padding-top: 20px;
  border-top: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.security-item {
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 14px;
  color: var(--muted);
}

@media (max-width: 968px) {
  .checkout-grid {
    grid-template-columns: 1fr;
  }
  
  .checkout-summary {
    position: static;
  }
}

.payment-method {
  cursor: pointer;
}

.payment-method.active {
  border-color: var(--green);
  background: rgba(22, 163, 74, 0.1);
}
</style>

<% 
// Prepare totalCents value in EJS block
const totalCentsValue = (cart && cart.totalCents) ? cart.totalCents : 0;
%>
<script id="checkout-data-script" type="application/json"><%- JSON.stringify({ totalCents: totalCentsValue }) %></script>
<script>
// Handle form submission
document.addEventListener('DOMContentLoaded', function() {
  document.getElementById('checkout-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const btn = document.getElementById('checkout-btn');
    const originalText = btn.innerHTML;
    const isDisabled = btn.disabled;
    
    if (isDisabled) return;
    
    btn.disabled = true;
    btn.innerHTML = '<span>‚è≥</span> ƒêang x·ª≠ l√Ω...';
    
    try {
      // MoMo payment flow
      const checkoutDataScript = document.getElementById('checkout-data-script');
      const checkoutData = checkoutDataScript ? JSON.parse(checkoutDataScript.textContent) : { totalCents: 0 };
      const totalCents = checkoutData.totalCents;
      
      const response = await fetch('/checkout/momo', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        credentials: 'same-origin'
      });
      
      if (!response.ok) {
        const errorText = await response.text();
        let errorMsg = 'Kh√¥ng th·ªÉ t·∫°o y√™u c·∫ßu thanh to√°n MoMo';
        try {
          const errorData = JSON.parse(errorText);
          errorMsg = errorData.message || errorMsg;
        } catch (e) {
          errorMsg = errorText || errorMsg;
        }
        alert(errorMsg);
        btn.disabled = false;
        btn.innerHTML = originalText;
        return;
      }
      
      const data = await response.json();
      
      if (data.success && data.payUrl) {
        // Redirect to MoMo payment page
        window.location.href = data.payUrl;
      } else {
        alert(data.message || 'Kh√¥ng th·ªÉ t·∫°o y√™u c·∫ßu thanh to√°n MoMo');
        btn.disabled = false;
        btn.innerHTML = originalText;
      }
    } catch (error) {
      console.error('Payment error:', error);
      alert('C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i.');
      btn.disabled = false;
      btn.innerHTML = originalText;
    }
  });
});
</script>


