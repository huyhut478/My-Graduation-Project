 
<div class="cart-container">
  <h1>Gi·ªè h√†ng c·ªßa b·∫°n</h1>
  
  <% if (!cart || !cart.totalQty || cart.totalQty === 0) { %>
    <div class="empty-cart">
      <div class="empty-cart-icon"><svg class="icon-cart" viewBox="0 0 576 512" width="48" height="48" aria-hidden="true"><path d="M551.991 64H144.28l-8.726-44.608C133.35 8.128 123.478 0 112 0H12C5.373 0 0 5.373 0 12v24c0 6.627 5.373 12 12 12h80.24l69.594 355.701C150.796 415.201 144 430.802 144 448c0 35.346 28.654 64 64 64s64-28.654 64-64a63.681 63.681 0 0 0-8.583-32h145.167a63.681 63.681 0 0 0-8.583 32c0 35.346 28.654 64 64 64 35.346 0 64-28.654 64-64 0-18.136-7.556-34.496-19.676-46.142l1.035-4.757c3.254-14.96-8.142-29.101-23.452-29.101H203.76l-9.39-48h312.405c11.29 0 21.054-7.869 23.452-18.902l45.216-208C578.695 78.139 567.299 64 551.991 64zM208 472c-13.234 0-24-10.766-24-24s10.766-24 24-24 24 10.766 24 24-10.766 24-24 24zm256 0c-13.234 0-24-10.766-24-24s10.766-24 24-24 24 10.766 24 24-10.766 24-24 24zm23.438-200H184.98l-31.31-160h368.548l-34.78 160z" fill="currentColor"></path></svg></div>
      <h3>Gi·ªè h√†ng tr·ªëng</h3>
      <p class="muted">B·∫°n ch∆∞a c√≥ s·∫£n ph·∫©m n√†o trong gi·ªè h√†ng.</p>
      <a href="/" class="btn primary">Ti·∫øp t·ª•c mua s·∫Øm</a>
    </div>
  <% } else { %>
    <form id="cart-form" action="/checkout" method="post">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
      <div class="cart-header">
        <label class="select-all">
          <input type="checkbox" id="select-all" onchange="toggleSelectAll()">
          <span>Ch·ªçn t·∫•t c·∫£</span>
        </label>
        <div class="selected-info">
          <span id="selected-count">0</span> s·∫£n ph·∫©m (<span id="selected-qty">0</span> m√≥n) ƒë√£ ch·ªçn
        </div>
      </div>
      
      <div class="cart-items">
        <% Object.values(cart.items || {}).forEach(({product, qty}) => { %>
          <div class="cart-item" data-product-id="<%= product?.id %>">
            <div class="item-checkbox">
              <input type="checkbox" name="selected_items" value="<%= product?.id %>" 
                     class="item-checkbox-input" onchange="updateSelectedTotal()" checked>
            </div>
            <div class="item-image">
              <img src="<%= (product && product.image) ? product.image : '/img/placeholder.jpg' %>" alt="<%= (product && product.title) ? product.title : 'S·∫£n ph·∫©m' %>" loading="lazy" decoding="async" />
            </div>
          <div class="item-details">
            <% if (product && product.slug) { %>
              <h3><a href="/product/<%= product.slug %>"><%= (product && product.title) ? product.title : 'S·∫£n ph·∫©m' %></a></h3>
            <% } else { %>
              <h3><%= (product && product.title) ? product.title : 'S·∫£n ph·∫©m' %></h3>
            <% } %>
            <% if (product && product.original_price_cents && product.original_price_cents > product.price_cents) { %>
              <% const orig = ((product.original_price_cents || 0)/100).toLocaleString('vi-VN',{style:'currency',currency:'VND'});
                 const curr = ((product.price_cents || 0)/100).toLocaleString('vi-VN',{style:'currency',currency:'VND'});
              %>
              <p class="item-price"><span style="text-decoration:line-through;color:var(--muted)"><%= orig %></span> <span style="color:var(--green);font-weight:700;margin-left:8px"><%= curr %></span> <span class="discount-pill small">-<%= product.discount_percent || 0 %>%</span></p>
            <% } else { %>
              <p class="item-price"><%= (((product && product.price_cents) ? product.price_cents : 0)/100).toLocaleString('vi-VN',{style:'currency',currency:'VND'}) %></p>
            <% } %>
            <div class="stock-info">
              <% if (product && product.stock && product.stock > 0) { %>
                <span class="in-stock">C√≤n h√†ng (<%= product.stock %> s·∫£n ph·∫©m)</span>
<% } else { %>
                <span class="out-of-stock">H·∫øt h√†ng</span>
              <% } %>
            </div>
          </div>
          <div class="item-controls">
            <% if (product && product.id) { %>
              <form action="/cart/update/<%= product.id %>?_csrf=<%= csrfToken %>" method="post" class="quantity-form">
                <div class="quantity-controls">
                  <button type="button" class="qty-btn minus" data-product-id="<%- product.id %>" data-delta="-1">-</button>
                  <input type="number" name="quantity" value="<%= qty %>" min="0" max="<%- (product && product.stock) ? product.stock : 999 %>" 
                         class="quantity-input" id="qty-<%- product.id %>" data-product-id="<%- product.id %>">
                  <button type="button" class="qty-btn plus" data-product-id="<%- product.id %>" data-delta="1">+</button>
                </div>
              </form>
              <div class="item-total">
                <span class="price"><%= (((product && product.price_cents) ? product.price_cents : 0) * qty / 100).toLocaleString('vi-VN',{style:'currency',currency:'VND'}) %></span>
              </div>
              <form action="/cart/remove/<%= product.id %>?_csrf=<%= csrfToken %>" method="post" class="remove-form">
                <button type="submit" class="btn-remove" title="X√≥a s·∫£n ph·∫©m">üóëÔ∏è</button>
            </form>
            <% } else { %>
              <p class="muted">S·∫£n ph·∫©m kh√¥ng h·ª£p l·ªá</p>
            <% } %>
          </div>
        </div>
      <% }) %>
      </div>
      
      <div class="cart-summary">
        <div class="summary-row">
          <span>T·∫°m t√≠nh:</span>
            <span id="subtotal"><%= (((cart && cart.originalTotalCents) ? cart.originalTotalCents : cart.totalCents)/100).toLocaleString('vi-VN',{style:'currency',currency:'VND'}) %></span>
        </div>
          <div class="summary-row discount">
            <span>Khuy·∫øn m√£i:</span>
            <span id="discount"><%= ((cart && cart.discountCents) ? '-' + (cart.discountCents/100).toLocaleString('vi-VN',{style:'currency',currency:'VND'}) : '-0 VND') %></span>
          </div>
          <div class="summary-row vat">
            <span>VAT (<%= (cart && cart.vatPercent) ? cart.vatPercent : 0 %>%)</span>
            <span id="vat"><%= ((cart && cart.vatCents) ? (cart.vatCents/100).toLocaleString('vi-VN',{style:'currency',currency:'VND'}) : '0 VND') %></span>
          </div>
        <div class="summary-row total">
          <span><strong>T·ªïng c·ªông:</strong></span>
            <span class="price" id="total"><%= (((cart && cart.grandTotalCents) ? cart.grandTotalCents : (cart.totalCents || 0))/100).toLocaleString('vi-VN',{style:'currency',currency:'VND'}) %></span>
        </div>
      </div>
      
      <div class="cart-actions">
        <a href="/" class="btn">Ti·∫øp t·ª•c mua s·∫Øm</a>
        <button type="button" class="btn primary" id="checkout-btn">
          Thanh to√°n (<span id="checkout-count">0</span>)
        </button>
      </div>
    </form>
  <% } %>
  </div>

<style>
.cart-container {
  max-width: 800px;
  margin: 0 auto;
}

.empty-cart {
  text-align: center;
  padding: 60px 20px;
}

.empty-cart-icon {
  font-size: 64px;
  margin-bottom: 20px;
}

.empty-cart h3 {
  margin: 0 0 10px 0;
  color: var(--fg);
}

.cart-items {
  margin-bottom: 30px;
}

.cart-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 20px;
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 12px;
  margin-bottom: 16px;
}

.select-all {
  display: flex;
  align-items: center;
  gap: 10px;
  cursor: pointer;
  font-weight: 600;
  user-select: none;
}

.select-all input[type="checkbox"] {
  width: 20px;
  height: 20px;
  cursor: pointer;
  accent-color: var(--green);
}

.selected-info {
  color: var(--muted);
  font-size: 14px;
}

.cart-item {
  display: flex;
  align-items: center;
  gap: 16px;
  padding: 20px;
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 12px;
  margin-bottom: 16px;
  transition: all 0.3s;
}

.cart-item:hover {
  border-color: var(--green);
  box-shadow: 0 4px 12px rgba(22, 163, 74, 0.1);
}

.item-checkbox {
  flex-shrink: 0;
}

.item-checkbox-input {
  width: 20px;
  height: 20px;
  cursor: pointer;
  accent-color: var(--green);
}

.item-image {
  width: 80px;
  height: 80px;
  flex-shrink: 0;
}

.item-image img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 8px;
}

.item-details {
  flex: 1;
  min-width: 0;
}

.item-details h3 {
  margin: 0 0 8px 0;
  font-size: 16px;
}

.item-details h3 a {
  color: var(--fg);
  text-decoration: none;
}

.item-details h3 a:hover {
  color: var(--green);
}

.item-price {
  margin: 0 0 8px 0;
  font-size: 14px;
  color: var(--green);
  font-weight: 600;
}

.stock-info {
  font-size: 12px;
}

.in-stock {
  color: #10b981;
}

.out-of-stock {
  color: #ef4444;
}

.item-controls {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: 12px;
}

.quantity-controls {
  display: flex;
  align-items: center;
  gap: 8px;
}

.qty-btn {
  width: 32px;
  height: 32px;
  border: 1px solid var(--border);
  background: var(--card);
  color: var(--fg);
  border-radius: 6px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  font-weight: bold;
}

.qty-btn:hover {
  background: var(--border);
}

.quantity-input {
  width: 60px;
  height: 32px;
  text-align: center;
  border: 1px solid var(--border);
  background: var(--card);
  color: var(--fg);
  border-radius: 6px;
  font-size: 14px;
}

.quantity-input:focus {
  outline: none;
  border-color: var(--green);
}

.item-total {
  font-size: 16px;
  font-weight: 600;
}

.btn-remove {
  background: none;
  border: none;
  color: #ef4444;
  cursor: pointer;
  font-size: 18px;
  padding: 8px;
  border-radius: 6px;
  transition: background-color 0.2s;
}

.btn-remove:hover {
  background: rgba(239, 68, 68, 0.1);
}

.cart-summary {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 20px;
}

.summary-row {
  display: flex;
  justify-content: space-between;
  margin-bottom: 12px;
}

.summary-row:last-child {
  margin-bottom: 0;
}

.summary-row.total {
  border-top: 1px solid var(--border);
  padding-top: 12px;
  font-size: 18px;
}

.cart-actions {
  display: flex;
  gap: 16px;
  justify-content: space-between;
  align-items: center;
}

.checkout-form {
  margin: 0;
}

@media (max-width: 768px) {
  .cart-item {
    flex-direction: column;
    align-items: flex-start;
    gap: 16px;
  }
  
  .item-controls {
    width: 100%;
    flex-direction: row;
    justify-content: space-between;
    align-items: center;
  }
  
  .cart-actions {
    flex-direction: column;
  }
  
  .cart-actions .btn {
    width: 100%;
    text-align: center;
  }
}
</style>

<% 
// Prepare cart data JSON in EJS block
let cartDataJson = '{}';
if (cart && cart.items) {
  const data = {};
  Object.values(cart.items).forEach((item) => {
    if (item && item.product && item.product.id) {
      data[item.product.id] = {
        price: item.product.price_cents || 0,
        original_price: (item.product.original_price_cents != null) ? item.product.original_price_cents : (item.product.price_cents || 0),
        discount_percent: item.product.discount_percent || 0,
        qty: item.qty || 0
      };
    }
  });
  cartDataJson = JSON.stringify(data);
}
%>
<script id="cart-data-script" type="application/json"><%- cartDataJson %></script>
<script id="cart-meta-script" type="application/json"><%- JSON.stringify({ vatPercent: (cart && cart.vatPercent) ? cart.vatPercent : 0, serverGrandTotal: (cart && cart.grandTotalCents) ? cart.grandTotalCents : ((cart && cart.totalCents) ? cart.totalCents : 0) }) %></script>
<script>
// Cart data initialization
const cartDataScript = document.getElementById('cart-data-script');
const cartData = cartDataScript ? JSON.parse(cartDataScript.textContent) : {};

// Event listeners for quantity buttons
document.addEventListener('DOMContentLoaded', function() {
  // Initialize cart data from current page state
  document.querySelectorAll('.cart-item').forEach(item => {
    const productId = parseInt(item.getAttribute('data-product-id'));
    const qtyInput = document.getElementById('qty-' + productId);
    if (qtyInput && cartData[productId]) {
      cartData[productId].qty = parseInt(qtyInput.value) || 0;
    }
  });
  
  // Initial update
  updateSelectedTotal();
  
  document.querySelectorAll('.qty-btn.minus, .qty-btn.plus').forEach(btn => {
    btn.addEventListener('click', function() {
      const productId = parseInt(this.getAttribute('data-product-id'));
      const delta = parseInt(this.getAttribute('data-delta'));
      changeQuantity(productId, delta);
    });
  });
  
  document.querySelectorAll('.quantity-input').forEach(input => {
    input.addEventListener('change', function() {
      const productId = parseInt(this.getAttribute('data-product-id'));
      updateQuantity(productId);
    });
  });
});

function changeQuantity(productId, delta) {
  const input = document.getElementById('qty-' + productId);
  if (!input) return;
  const currentValue = parseInt(input.value) || 0;
  const newValue = Math.max(0, currentValue + delta);
  input.value = newValue;
  // Update cartData immediately
  if (cartData[productId]) {
    cartData[productId].qty = newValue;
  }
  // Update UI immediately
  updateSelectedTotal();
  // Update item total price
  const itemTotalEl = input.closest('.item-controls').querySelector('.item-total .price');
  if (itemTotalEl && cartData[productId]) {
    const totalPrice = (cartData[productId].price * newValue / 100).toLocaleString('vi-VN', {style:'currency',currency:'VND'});
    itemTotalEl.textContent = totalPrice;
  }
  updateQuantity(productId);
}

function updateQuantity(productId) {
  const input = document.getElementById('qty-' + productId);
  const form = input.closest('.quantity-form');
  // Update cartData
  if (cartData[productId]) {
    cartData[productId].qty = parseInt(input.value) || 0;
  }
  // Update UI immediately before submit
  updateSelectedTotal();
  // Update item total price
  const itemTotalEl = input.closest('.item-controls').querySelector('.item-total .price');
  if (itemTotalEl && cartData[productId]) {
    const totalPrice = (cartData[productId].price * cartData[productId].qty / 100).toLocaleString('vi-VN', {style:'currency',currency:'VND'});
    itemTotalEl.textContent = totalPrice;
  }
  form.submit();
}

function toggleSelectAll() {
  const selectAll = document.getElementById('select-all');
  const checkboxes = document.querySelectorAll('.item-checkbox-input');
  checkboxes.forEach(cb => {
    cb.checked = selectAll.checked;
  });
  updateSelectedTotal();
}

function updateSelectedTotal() {
  try {
    const checkboxes = document.querySelectorAll('.item-checkbox-input:checked');
    const selectedCount = checkboxes.length;
    
    let totalCents = 0;
    let originalTotalCents = 0;
    let totalQty = 0; // T·ªïng s·ªë l∆∞·ª£ng th·ª±c t·∫ø
    
    checkboxes.forEach(cb => {
      const productId = parseInt(cb.value);
      if (cartData[productId]) {
        const qty = cartData[productId].qty || 0;
        const price = cartData[productId].price || 0;
        const original = (cartData[productId].original_price != null) ? cartData[productId].original_price : price;
        totalCents += price * qty;
        originalTotalCents += original * qty;
        totalQty += qty; // C·ªông s·ªë l∆∞·ª£ng th·ª±c t·∫ø
      }
    });
    
    // Update UI
    const selectedCountEl = document.getElementById('selected-count');
    const selectedQtyEl = document.getElementById('selected-qty');
    const checkoutCountEl = document.getElementById('checkout-count');
    const subtotalEl = document.getElementById('subtotal');
    const totalEl = document.getElementById('total');
    const checkoutBtn = document.getElementById('checkout-btn');
    
    if (selectedCountEl) selectedCountEl.textContent = selectedCount;
    if (selectedQtyEl) selectedQtyEl.textContent = totalQty;
    if (checkoutCountEl) checkoutCountEl.textContent = totalQty; // Hi·ªÉn th·ªã t·ªïng s·ªë l∆∞·ª£ng th·ª±c t·∫ø
    
    const formattedTotal = (totalCents / 100).toLocaleString('vi-VN', {
      style: 'currency',
      currency: 'VND'
    });
    // Get VAT percent from cart meta
    const cartMetaScript = document.getElementById('cart-meta-script');
    const cartMeta = cartMetaScript ? JSON.parse(cartMetaScript.textContent) : { vatPercent: 0 };
    const vatPercentLocal = Number(cartMeta.vatPercent || 0);
    const vatCentsLocal = Math.round(totalCents * vatPercentLocal / 100);
    const formattedVat = (vatCentsLocal / 100).toLocaleString('vi-VN', { style: 'currency', currency: 'VND' });
    const formattedGrand = ((totalCents + vatCentsLocal) / 100).toLocaleString('vi-VN', { style: 'currency', currency: 'VND' });
    const formattedSubtotal = (originalTotalCents / 100).toLocaleString('vi-VN', {
      style: 'currency',
      currency: 'VND'
    });
    const discountCents = Math.max(0, originalTotalCents - totalCents);
    const formattedDiscount = '-' + (discountCents / 100).toLocaleString('vi-VN', { style: 'currency', currency: 'VND' });
    
    if (subtotalEl) subtotalEl.textContent = formattedSubtotal;
    if (totalEl) totalEl.textContent = formattedGrand;
    const discountEl = document.getElementById('discount');
    if (discountEl) discountEl.textContent = (discountCents > 0) ? formattedDiscount : '-0 VND';
    const vatEl = document.getElementById('vat');
    if (vatEl) vatEl.textContent = formattedVat;
    
    // Always enable checkout button if there are items in cart
    // The form submit handler will check if items are selected
    if (checkoutBtn) {
      const allCheckboxes = document.querySelectorAll('.item-checkbox-input');
      if (allCheckboxes.length > 0) {
        // Enable button if there are any items (selected or not)
        checkoutBtn.disabled = false;
        // But add visual feedback if nothing is selected
        if (selectedCount === 0) {
          checkoutBtn.style.opacity = '0.5';
          checkoutBtn.style.cursor = 'not-allowed';
        } else {
          checkoutBtn.style.opacity = '1';
          checkoutBtn.style.cursor = 'pointer';
        }
      } else {
        checkoutBtn.disabled = true;
      }
    }
    
    // Update select all checkbox
    const allCheckboxes = document.querySelectorAll('.item-checkbox-input');
    const selectAll = document.getElementById('select-all');
    if (selectAll) {
      if (selectedCount === allCheckboxes.length && allCheckboxes.length > 0) {
        selectAll.checked = true;
        selectAll.indeterminate = false;
      } else if (selectedCount > 0) {
        selectAll.checked = false;
        selectAll.indeterminate = true;
      } else {
        selectAll.checked = false;
        selectAll.indeterminate = false;
      }
    }
  } catch (error) {
    console.error('Error in updateSelectedTotal:', error);
  }
}

// Handle form submission - ensure it's set up after DOM is ready
function setupFormSubmit() {
  const cartForm = document.getElementById('cart-form');
  if (!cartForm) {
    console.error('Cart form not found!');
    return;
  }
  
  // Remove any existing submit listeners by replacing the form's submit handler
  cartForm.onsubmit = null;
  
  // Add event listener to the form
  cartForm.addEventListener('submit', function(e) {
    e.preventDefault(); // Always prevent default first
    console.log('Form submit event triggered');
    
    const selected = document.querySelectorAll('.item-checkbox-input:checked');
    console.log('Selected items count:', selected.length);
    
    if (selected.length === 0) {
      alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt s·∫£n ph·∫©m ƒë·ªÉ thanh to√°n');
      return false;
    }
    
    // Get selected values
    const selectedValues = Array.from(selected).map(cb => cb.value);
    console.log('Submitting form with selected items:', selectedValues);
    
    // Get CSRF token
    const csrfInput = cartForm.querySelector('input[name="_csrf"]');
    const csrfToken = csrfInput ? csrfInput.value : '';
    
    // Create a new form to submit
    const submitForm = document.createElement('form');
    submitForm.method = 'POST';
    submitForm.action = '/checkout';
    submitForm.style.display = 'none';
    
    // Add CSRF token
    if (csrfToken) {
      const csrfField = document.createElement('input');
      csrfField.type = 'hidden';
      csrfField.name = '_csrf';
      csrfField.value = csrfToken;
      submitForm.appendChild(csrfField);
    }
    
    // Add selected items
    selectedValues.forEach(value => {
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = 'selected_items';
      input.value = value;
      submitForm.appendChild(input);
    });
    
    document.body.appendChild(submitForm);
    console.log('Submitting form...');
    submitForm.submit();
  });
  
  // Add click handler to button (button is now type="button" so we handle it directly)
  const checkoutBtn = document.getElementById('checkout-btn');
  if (checkoutBtn) {
    checkoutBtn.addEventListener('click', function(e) {
      console.log('Checkout button clicked');
      e.preventDefault();
      e.stopPropagation();
      
      // Get selected items
      const selected = document.querySelectorAll('.item-checkbox-input:checked');
      console.log('Selected items count:', selected.length);
      
      if (selected.length === 0) {
        alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt s·∫£n ph·∫©m ƒë·ªÉ thanh to√°n');
        return false;
      }
      
      // Get selected values
      const selectedValues = Array.from(selected).map(cb => cb.value);
      console.log('Submitting form with selected items:', selectedValues);
      
      // Get CSRF token
      const csrfInput = cartForm.querySelector('input[name="_csrf"]');
      const csrfToken = csrfInput ? csrfInput.value : '';
      
      // Create a new form to submit
      const submitForm = document.createElement('form');
      submitForm.method = 'POST';
      submitForm.action = '/checkout';
      submitForm.style.display = 'none';
      
      // Add CSRF token
      if (csrfToken) {
        const csrfField = document.createElement('input');
        csrfField.type = 'hidden';
        csrfField.name = '_csrf';
        csrfField.value = csrfToken;
        submitForm.appendChild(csrfField);
      }
      
      // Add selected items
      selectedValues.forEach(value => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'selected_items';
        input.value = value;
        submitForm.appendChild(input);
      });
      
      document.body.appendChild(submitForm);
      console.log('Submitting form...');
      submitForm.submit();
    });
    
    console.log('Checkout button handler attached');
  } else {
    console.error('Checkout button not found!');
  }
  
  console.log('Form submit handler attached successfully');
  console.log('Cart form:', cartForm);
  console.log('Checkout button:', checkoutBtn);
}

// Initialize function
function initializeCart() {
  try {
    // Check all checkboxes by default (they are already checked in HTML)
    const checkboxes = document.querySelectorAll('.item-checkbox-input');
    if (checkboxes.length > 0) {
      checkboxes.forEach(cb => {
        if (!cb.checked) {
          cb.checked = true;
        }
      });
      
      // Update select all checkbox state
      const selectAll = document.getElementById('select-all');
      const checkedCount = document.querySelectorAll('.item-checkbox-input:checked').length;
      if (selectAll && checkboxes.length > 0 && checkboxes.length === checkedCount) {
        selectAll.checked = true;
        selectAll.indeterminate = false;
      }
      
      // Calculate totals
      updateSelectedTotal();
    } else {
      // No items in cart, ensure button is disabled
      const checkoutBtn = document.getElementById('checkout-btn');
      if (checkoutBtn) {
        checkoutBtn.disabled = true;
      }
    }
    
    // Setup form submit handler
    setupFormSubmit();
  } catch (error) {
    console.error('Error initializing cart:', error);
  }
}

// Initialize on load - try immediately if DOM is ready, otherwise wait
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initializeCart);
} else {
  // DOM is already ready
  initializeCart();
}
</script>


