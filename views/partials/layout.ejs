<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    
    <!-- SEO Meta Tags -->
    <title><%= typeof title !== 'undefined' ? title : 'SafeKeyS - C·ª≠a h√†ng Key Ph·∫ßn M·ªÅm, Game Ch√≠nh H√£ng' %></title>
    <meta name="description" content="<%= typeof description !== 'undefined' ? description : 'SafeKeyS - C·ª≠a h√†ng chuy√™n cung c·∫•p key b·∫£n quy·ªÅn ph·∫ßn m·ªÅm, game v√† th·∫ª n·∫°p uy t√≠n, nhanh ch√≥ng. Giao h√†ng t·ª± ƒë·ªông trong 5 ph√∫t, h·ªó tr·ª£ 24/7.' %>" />
    <meta name="keywords" content="key ph·∫ßn m·ªÅm, key game, b·∫£n quy·ªÅn, windows, office, steam wallet, game keys, software keys" />
    <meta name="author" content="SafeKeyS" />
    <meta name="robots" content="index, follow" />
    <link rel="canonical" href="<%= typeof canonical !== 'undefined' ? canonical : '' %>" />
    
    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content="<%= typeof ogUrl !== 'undefined' ? ogUrl : 'http://localhost:3000' %>" />
    <meta property="og:title" content="<%= typeof title !== 'undefined' ? title : 'SafeKeyS - C·ª≠a h√†ng Key Ph·∫ßn M·ªÅm, Game Ch√≠nh H√£ng' %>" />
    <meta property="og:description" content="<%= typeof description !== 'undefined' ? description : 'C·ª≠a h√†ng chuy√™n cung c·∫•p key b·∫£n quy·ªÅn ph·∫ßn m·ªÅm, game v√† th·∫ª n·∫°p uy t√≠n, nhanh ch√≥ng.' %>" />
    <meta property="og:image" content="<%= typeof ogImage !== 'undefined' ? ogImage : '/img/placeholder.jpg' %>" />
    
    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content="<%= typeof ogUrl !== 'undefined' ? ogUrl : 'http://localhost:3000' %>" />
    <meta property="twitter:title" content="<%= typeof title !== 'undefined' ? title : 'SafeKeyS' %>" />
    <meta property="twitter:description" content="<%= typeof description !== 'undefined' ? description : 'C·ª≠a h√†ng key ph·∫ßn m·ªÅm v√† game ch√≠nh h√£ng' %>" />
    <meta property="twitter:image" content="<%= typeof ogImage !== 'undefined' ? ogImage : '/img/placeholder.jpg' %>" />
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico" />
    
    <!-- Performance -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="dns-prefetch" href="https://fonts.googleapis.com" />
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="/css/style.css" />
    
    <!-- Theme Color -->
    <meta name="theme-color" content="#16a34a" />
    
    <!-- Structured Data (JSON-LD) -->
    <% if (typeof structuredData !== 'undefined' && structuredData) { %>
      <script type="application/ld+json">
        <%- JSON.stringify(structuredData) %>
      </script>
    <% } %>
  </head>
  <body>
    <a href="#main-content" class="skip-link">B·ªè qua ƒë·∫øn n·ªôi dung ch√≠nh</a>
    <header>
      <div class="container">
        <!-- H√†ng 1: Brand, Search, Auth + Cart -->
        <div class="nav nav-top">
          <button class="mobile-menu-toggle" onclick="toggleMobileMenu()" aria-label="Menu" id="mobile-menu-btn">
            ‚ò∞
          </button>
          <a href="/" class="brand"><span class="dot"></span> SafeKeyS</a>
        <form class="search-form search" action="/" method="get" role="search">
          <input type="text" name="q" placeholder="T√¨m ki·∫øm..." value="<%= typeof q !== 'undefined' ? q : '' %>" aria-label="T√¨m ki·∫øm s·∫£n ph·∫©m" />
          <button type="submit" aria-label="T√¨m ki·∫øm">T√¨m</button>
        </form>
          <div class="nav-user">
            <% if (typeof currentUser !== 'undefined' && currentUser) { %>
              <div class="user-greeting-top">
                <% if (currentUser.avatar) { %>
                  <% 
                    // Add cache-busting timestamp for local avatars
                    let avatarUrlHeader = currentUser.avatar;
                    if (!currentUser.avatar.startsWith('http') && !currentUser.avatar.startsWith('https')) {
                      // Add timestamp to bypass browser cache
                      avatarUrlHeader = currentUser.avatar + (currentUser.avatar.includes('?') ? '&' : '?') + 't=' + Date.now();
                    }
                  %>
                  <img src="<%= avatarUrlHeader %>" alt="<%= currentUser.name || 'User' %>" class="user-avatar-small" />
                <% } else { %>
                  <div class="user-avatar-placeholder">
                    <span><%= ((currentUser && currentUser.name) ? currentUser.name : 'U').charAt(0).toUpperCase() %></span>
                  </div>
                <% } %>
                <span class="user-name-top"><%= currentUser.name || 'User' %></span>
              </div>
              <div class="user-actions">
              <a href="/wishlist" class="btn wishlist-btn-header" title="Danh s√°ch y√™u th√≠ch" aria-label="Danh s√°ch y√™u th√≠ch">
                <span aria-hidden="true">‚ù§Ô∏è</span>
                <span class="wishlist-text">Y√™u th√≠ch</span>
              </a>
                <a href="/orders" class="btn">L·ªãch s·ª≠ giao d·ªãch</a>
                <a href="/profile" class="btn">H·ªì s∆°</a>
                <form action="/logout?_csrf=<%= typeof csrfToken !== 'undefined' ? csrfToken : '' %>" method="post" onsubmit="return confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ƒëƒÉng xu·∫•t?')" style="margin:0">
                  <button class="btn">ƒêƒÉng xu·∫•t</button>
                </form>
              </div>
            <% } else { %>
              <div class="auth-links">
                <a class="btn" href="/login">ƒêƒÉng nh·∫≠p</a>
                <a class="btn primary" href="/register">ƒêƒÉng k√Ω</a>
              </div>
            <% } %>
            
          <a class="btn cart-btn" href="/cart" aria-label="Gi·ªè h√†ng" title="Gi·ªè h√†ng" id="cart-link">
            <span class="cart-icon" aria-hidden="true">üõí</span>
            <span class="cart-text">Gi·ªè h√†ng</span>
            <% if (typeof currentUser !== 'undefined' && currentUser && typeof cart !== 'undefined' && cart && cart.totalQty && cart.totalQty > 0) { %>
              <span class="cart-badge" id="cart-badge" aria-label="S·ªë l∆∞·ª£ng s·∫£n ph·∫©m trong gi·ªè: <%= cart.totalQty %>"><%= cart.totalQty %></span>
            <% } else if (typeof currentUser !== 'undefined' && currentUser) { %>
              <span class="cart-badge" id="cart-badge" style="display: none;" aria-label="S·ªë l∆∞·ª£ng s·∫£n ph·∫©m trong gi·ªè: 0">0</span>
            <% } %>
          </a>
          </div>
        </div>
        
        <!-- H√†ng 2: Navigation Links + Admin Menu -->
        <div class="nav nav-bottom" id="mobile-menu">
          <div class="nav-links">
            <a class="btn" href="/categories">Danh m·ª•c</a>
            <a class="btn" href="/news">Tin t·ª©c</a>
            <a class="btn" href="/payment">Thanh to√°n</a>
            <a class="btn" href="/policy">Ch√≠nh s√°ch</a>
          </div>
          
          <% if (typeof currentUser !== 'undefined' && currentUser) { %>
            <div class="user-info">
              <% if (currentUser.role === 'admin') { %>
                <div class="admin-menu">
                  <a href="/admin" class="btn admin">Admin</a>
                  <a href="/admin/products" class="btn admin">S·∫£n ph·∫©m</a>
                  <a href="/admin/categories" class="btn admin">Danh m·ª•c</a>
                  <a href="/admin/orders" class="btn admin">Qu·∫£n l√Ω ƒë∆°n h√†ng</a>
                  <a href="/admin/news" class="btn admin">Tin t·ª©c</a>
                  <a href="/admin/settings" class="btn admin">C√†i ƒë·∫∑t</a>
                </div>
              <% } %>
            </div>
          <% } %>
        </div>
      </div>
    </header>
    <main id="main-content" class="container">
      <% if (typeof flash !== 'undefined' && flash && flash.success && flash.success.length) { %>
        <div class="flash success"><%= flash.success.join('<br/>') %></div>
      <% } %>
      <% if (typeof flash !== 'undefined' && flash && flash.error && flash.error.length) { %>
        <div class="flash error"><%= flash.error.join('<br/>') %></div>
      <% } %>
      <%- body %>
    </main>
    <footer>
      <div class="container row" style="justify-content:space-between;align-items:center">
        <div>
          ¬© <%= new Date().getFullYear() %> SafeKeyS ¬∑ 
          <a class="muted" href="/about" style="margin-right:8px">Gi·ªõi thi·ªáu</a>
          <a class="muted" href="/policy" style="margin-right:8px">Ch√≠nh s√°ch</a>
          <a class="muted" href="/payment" style="margin-right:8px">Thanh to√°n</a>
          <a class="muted" href="/contact" style="margin-right:12px">Li√™n h·ªá</a>
        </div>
        <div class="row" style="gap:10px">
          <%
            const socialList = settings && settings.social_media_list ? settings.social_media_list : [];
            if (Array.isArray(socialList)) {
              socialList.forEach(item => {
                if (item && item.url && item.url.trim()) {
          %>
            <a class="btn" href="<%= item.url.trim() %>" target="_blank" rel="noopener noreferrer" aria-label="<%= item.name || 'Social' %>" title="<%= item.name || 'Social' %>" style="display:inline-flex;align-items:center;justify-content:center;padding:8px;min-width:40px;min-height:40px;">
              <% if (item.icon && item.icon.trim()) { %>
                <img src="<%= item.icon.trim() %>" alt="<%= item.name || 'Social' %>" style="width:24px;height:24px;object-fit:contain;border-radius:4px;display:block;" />
              <% } %>
            </a>
          <%
                }
              });
            }
          %>
        </div>
      </div>
    </footer>
    
    <script>
      function toggleMobileMenu() {
        const menu = document.getElementById('mobile-menu');
        const btn = document.getElementById('mobile-menu-btn');
        if (menu) {
          menu.classList.toggle('mobile-open');
          if (btn) {
            btn.textContent = menu.classList.contains('mobile-open') ? '‚úï' : '‚ò∞';
          }
        }
      }
      
      // Close mobile menu when clicking outside
      document.addEventListener('click', function(e) {
        const menu = document.getElementById('mobile-menu');
        const btn = document.getElementById('mobile-menu-btn');
        if (menu && btn && !menu.contains(e.target) && !btn.contains(e.target)) {
          menu.classList.remove('mobile-open');
          if (btn) btn.textContent = '‚ò∞';
        }
      });
      
      // Close mobile menu on window resize (if becomes desktop)
      window.addEventListener('resize', function() {
        if (window.innerWidth > 900) {
          const menu = document.getElementById('mobile-menu');
          const btn = document.getElementById('mobile-menu-btn');
          if (menu) menu.classList.remove('mobile-open');
          if (btn) btn.textContent = '‚ò∞';
        }
      });
    </script>
  </body>
  </html>


