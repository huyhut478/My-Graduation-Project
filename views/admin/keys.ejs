<div class="admin-keys-container">
  <div class="keys-header">
    <div class="header-content">
      <h1>üîë Qu·∫£n l√Ω Key</h1>
      <p class="header-subtitle">Qu·∫£n l√Ω v√† ch·ªânh s·ª≠a key cho c√°c ƒë∆°n h√†ng</p>
    </div>
    <div class="header-actions">
      <a href="/admin" class="btn secondary">‚Üê Quay l·∫°i Admin</a>
    </div>
  </div>

  <% if (typeof flash !== 'undefined' && flash.success && flash.success.length) { %>
    <div class="success-message">
      <%= flash.success.join('<br/>') %>
    </div>
  <% } %>

  <% if (typeof flash !== 'undefined' && flash.error && flash.error.length) { %>
    <div class="error-message">
      <%= flash.error.join('<br/>') %>
    </div>
  <% } %>

  <!-- Key Display Settings -->
  <div class="settings-section">
    <div class="settings-section-header">
      <div>
        <h2 class="settings-section-title">C√†i ƒë·∫∑t hi·ªÉn th·ªã Key</h2>
        <p class="settings-section-description">
          T√πy ch·ªânh n·ªôi dung hi·ªÉn th·ªã khi kh√°ch h√†ng xem key trong trang ƒë∆°n h√†ng.
        </p>
      </div>
    </div>
    
    <form method="POST" action="/admin/keys/settings" class="settings-form">
      <div class="form-group">
        <label for="key_display_title">
          Ti√™u ƒë·ªÅ hi·ªÉn th·ªã Key <span class="required">*</span>
        </label>
        <input
          type="text"
          id="key_display_title"
          name="key_display_title"
          value="<%= keyDisplayTitle || 'üîë Key c·ªßa b·∫°n' %>"
          placeholder="V√≠ d·ª•: üîë Key c·ªßa b·∫°n"
          required
          maxlength="100"
        />
      </div>

      <div class="form-group">
        <label for="key_display_message">
          Th√¥ng b√°o hi·ªÉn th·ªã Key <span class="required">*</span>
        </label>
        <textarea
          id="key_display_message"
          name="key_display_message"
          rows="4"
          placeholder="Nh·∫≠p th√¥ng b√°o hi·ªÉn th·ªã key..."
          required
        ><%= keyDisplayMessage || 'Key ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë·∫øn email c·ªßa b·∫°n. Vui l√≤ng ki·ªÉm tra h·ªôp th∆∞ spam n·∫øu kh√¥ng th·∫•y.' %></textarea>
      </div>

      <button type="submit" class="btn primary">üíæ L∆∞u c√†i ƒë·∫∑t</button>
    </form>
  </div>

  <!-- Products and Keys List -->
  <div class="products-section">
    <h2>üì¶ S·∫£n ph·∫©m v√† Key</h2>
    <p class="section-description">M·ªói s·∫£n ph·∫©m c√≥ 1 key. Qu·∫£n l√Ω key cho t·ª´ng s·∫£n ph·∫©m t·∫°i ƒë√¢y.</p>
    
    <% if (!products || products.length === 0) { %>
      <div class="empty-state">
        <p>Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o</p>
      </div>
    <% } else { %>
      <div class="products-list">
        <% products.forEach(product => { %>
          <div class="product-card">
            <div class="product-card-header">
              <div class="product-info">
                <% if (product.image) { %>
                  <img src="<%= product.image %>" alt="<%= product.title %>" class="product-image" />
                <% } %>
                <div>
                  <h3><%= product.title %></h3>
                  <p class="product-meta">
                    <span>üìÅ <%= product.category_name || 'Ch∆∞a ph√¢n lo·∫°i' %></span>
                    <span>üí∞ <%= (product.price_cents/100).toLocaleString('vi-VN',{style:'currency',currency:'VND'}) %></span>
                    <span>üì¶ T·ªìn kho: <%= product.stock || 0 %></span>
                    <span>üõí ƒê√£ b√°n: <%= (orderCounts && orderCounts[product.id]) ? orderCounts[product.id] : 0 %></span>
                  </p>
                </div>
              </div>
              <a href="/product/<%= product.slug %>" target="_blank" class="btn-view-product">Xem s·∫£n ph·∫©m ‚Üí</a>
            </div>

            <div class="product-key-section">
              <div class="key-header-row">
                <h4>üîë Key c·ªßa s·∫£n ph·∫©m</h4>
              </div>
              
              <% if (product.key_value) { %>
                <div class="key-display">
                  <div class="key-row">
                    <div class="key-info">
                      <code class="key-value" data-key-value="<%= product.key_value %>"><%= product.key_value %></code>
                    </div>
                    <div class="key-actions">
                      <button class="btn-copy" data-key-value="<%= product.key_value %>" type="button" title="Sao ch√©p">üìã</button>
                      <form action="/admin/products/<%= product.id %>/key/delete?_csrf=<%= csrfToken %>" method="post" style="display:inline;" onsubmit="return confirm('X√≥a key n√†y?')">
                        <button type="submit" class="btn-delete" title="X√≥a key">üóëÔ∏è</button>
                      </form>
                    </div>
                  </div>
                </div>
              <% } else { %>
                <div class="no-key-message">
                  <p>‚ö†Ô∏è S·∫£n ph·∫©m ch∆∞a c√≥ key</p>
                </div>
              <% } %>

              <form class="add-key-form" data-product-id="<%= product.id %>">
                <div class="add-key-row">
                  <input
                    type="text"
                    name="key_value"
                    value="<%= product.key_value || '' %>"
                    placeholder="Nh·∫≠p key cho s·∫£n ph·∫©m..."
                    class="key-input"
                    data-product-id="<%= product.id %>"
                  />
                  <button type="submit" class="btn-add" data-product-id="<%= product.id %>"><%= product.key_value ? '‚úèÔ∏è C·∫≠p nh·∫≠t Key' : '‚ûï Th√™m Key' %></button>
                </div>
              </form>
            </div>
          </div>
        <% }) %>
      </div>
    <% } %>
  </div>
</div>

<style>
.admin-keys-container {
  max-width: 1400px;
  margin: 0 auto;
  padding: 20px;
  position: relative;
  z-index: 1;
  min-height: calc(100vh - 300px);
  isolation: isolate;
}

/* Ensure container is not hidden by layout */
body > main > .container {
  overflow: visible !important;
}

.admin-keys-container * {
  box-sizing: border-box;
}

.keys-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 30px;
  padding-bottom: 20px;
  border-bottom: 2px solid var(--border);
  flex-wrap: wrap;
  gap: 16px;
}

.keys-header .header-actions {
  flex-shrink: 0;
}

.header-content h1 {
  margin: 0 0 8px 0;
  font-size: 32px;
  color: var(--fg);
}

.header-subtitle {
  margin: 0;
  color: var(--muted);
  font-size: 16px;
}

.success-message,
.error-message {
  padding: 16px 20px;
  border-radius: 8px;
  margin-bottom: 20px;
}

.success-message {
  background: rgba(22, 163, 74, 0.1);
  border: 1px solid rgba(22, 163, 74, 0.3);
  color: #10b981;
}

.error-message {
  background: rgba(239, 68, 68, 0.1);
  border: 1px solid rgba(239, 68, 68, 0.3);
  color: #ef4444;
}

.settings-section {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 30px;
  margin-bottom: 30px;
}

.settings-section-header {
  margin-bottom: 20px;
}

.settings-section-title {
  margin: 0 0 8px 0;
  font-size: 20px;
  color: var(--fg);
}

.settings-section-description {
  margin: 0;
  color: var(--muted);
  font-size: 14px;
}

.settings-form {
  margin-top: 20px;
}

.form-group {
  margin-bottom: 20px;
}

.form-group label {
  display: block;
  margin-bottom: 8px;
  color: var(--fg);
  font-weight: 600;
  font-size: 14px;
}

.form-group .required {
  color: #ef4444;
}

.form-group input,
.form-group textarea {
  width: 100%;
  padding: 12px 16px;
  border: 1px solid var(--border);
  border-radius: 8px;
  background: var(--card);
  color: var(--fg);
  font-size: 14px;
  font-family: inherit;
}

.form-group input:focus,
.form-group textarea:focus {
  outline: none;
  border-color: var(--green);
  box-shadow: 0 0 0 3px rgba(22, 163, 74, 0.1);
}

.form-group textarea {
  resize: vertical;
  min-height: 100px;
}

.products-section {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 30px;
}

.products-section h2 {
  margin: 0 0 24px 0;
  font-size: 24px;
  color: var(--fg);
  border-bottom: 2px solid var(--green);
  padding-bottom: 12px;
}

.products-list {
  display: flex;
  flex-direction: column;
  gap: 24px;
}

.product-card {
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 24px;
  background: rgba(255, 255, 255, 0.02);
}

.product-card-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 20px;
  padding-bottom: 16px;
  border-bottom: 1px solid var(--border);
  flex-wrap: wrap;
  gap: 16px;
}

.product-info {
  display: flex;
  gap: 16px;
  align-items: flex-start;
  flex: 1;
}

.product-image {
  width: 80px;
  height: 80px;
  object-fit: cover;
  border-radius: 8px;
  border: 1px solid var(--border);
}

.product-info h3 {
  margin: 0 0 8px 0;
  font-size: 20px;
  color: var(--fg);
}

.product-meta {
  display: flex;
  gap: 16px;
  flex-wrap: wrap;
  margin: 0;
  color: var(--muted);
  font-size: 14px;
}

.status-badge {
  padding: 4px 12px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 600;
}

.status-paid,
.status-completed {
  background: rgba(22, 163, 74, 0.2);
  color: #10b981;
}

.status-pending {
  background: rgba(245, 158, 11, 0.2);
  color: #f59e0b;
}

.status-failed,
.status-cancelled {
  background: rgba(239, 68, 68, 0.2);
  color: #ef4444;
}

/* Removed old order-item-card styles - now using product-key-section */

.key-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px;
  background: rgba(22, 163, 74, 0.1);
  border: 1px solid rgba(22, 163, 74, 0.3);
  border-radius: 6px;
  gap: 12px;
  flex-wrap: wrap;
}

.key-info {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.key-number {
  font-size: 11px;
  font-weight: 600;
  color: var(--green);
  text-transform: uppercase;
}

.key-value {
  font-family: 'Courier New', monospace;
  font-size: 14px;
  color: var(--fg);
  word-break: break-all;
  padding: 8px;
  background: rgba(0, 0, 0, 0.2);
  border-radius: 4px;
}

.key-date {
  font-size: 11px;
  color: var(--muted);
}

.key-actions {
  display: flex;
  gap: 8px;
  flex-shrink: 0;
}

.btn-copy,
.btn-delete {
  padding: 8px 12px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 16px;
  transition: all 0.2s;
}

.btn-copy {
  background: var(--green);
  color: white;
}

.btn-copy:hover {
  background: #16a34a;
}

.btn-delete {
  background: #ef4444;
  color: white;
}

.btn-delete:hover {
  background: #dc2626;
}

/* Removed no-keys style - using no-key-message instead */

.add-key-form {
  margin-top: 12px;
}

.add-key-row {
  display: flex;
  gap: 8px;
}

.key-input {
  flex: 1;
  padding: 10px 12px;
  border: 1px solid var(--border);
  border-radius: 6px;
  background: var(--card);
  color: var(--fg);
  font-family: 'Courier New', monospace;
  font-size: 14px;
}

.key-input:focus {
  outline: none;
  border-color: var(--green);
}

.btn-add {
  padding: 10px 16px;
  background: var(--green);
  border: none;
  border-radius: 6px;
  color: white;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
  white-space: nowrap;
  transition: all 0.2s;
}

.btn-add:hover {
  background: #16a34a;
}

.btn-view-product {
  padding: 8px 16px;
  background: transparent;
  border: 1px solid var(--green);
  border-radius: 6px;
  color: var(--green);
  text-decoration: none;
  font-size: 14px;
  font-weight: 600;
  transition: all 0.2s;
  white-space: nowrap;
}

.btn-view-product:hover {
  background: var(--green);
  color: white;
}

.product-key-section {
  margin-top: 20px;
  padding-top: 20px;
  border-top: 1px solid var(--border);
}

.key-header-row {
  margin-bottom: 16px;
}

.key-header-row h4 {
  margin: 0;
  font-size: 18px;
  color: var(--fg);
}

.key-display {
  margin-bottom: 16px;
}

.no-key-message {
  padding: 16px;
  text-align: center;
  color: #f59e0b;
  background: rgba(245, 158, 11, 0.1);
  border: 1px dashed rgba(245, 158, 11, 0.3);
  border-radius: 6px;
  margin-bottom: 16px;
}

.no-key-message p {
  margin: 0;
  font-size: 14px;
  font-weight: 500;
}

.section-description {
  margin: 0 0 24px 0;
  color: var(--muted);
  font-size: 14px;
}

/* Mobile Responsive */
@media (max-width: 768px) {
  .admin-keys-container {
    padding: 15px;
    min-height: auto;
  }

  .keys-header {
    flex-direction: column;
    align-items: stretch;
    gap: 16px;
  }

  .header-content h1 {
    font-size: 24px;
  }

  .header-subtitle {
    font-size: 14px;
  }

  .settings-section,
  .products-section {
    padding: 20px;
    margin-bottom: 20px;
  }

  .product-card {
    padding: 16px;
  }

  .product-card-header {
    flex-direction: column;
    align-items: stretch;
    gap: 12px;
  }

  .product-info {
    flex-direction: column;
    gap: 12px;
  }

  .product-image {
    width: 60px;
    height: 60px;
  }

  .product-meta {
    flex-direction: column;
    gap: 8px;
  }

  .order-item-card {
    padding: 16px;
  }

  .item-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 12px;
  }

  .key-row {
    flex-direction: column;
    align-items: stretch;
    gap: 12px;
  }

  .key-info {
    width: 100%;
  }

  .key-actions {
    width: 100%;
    display: flex;
    gap: 8px;
  }

  .btn-copy,
  .btn-delete {
    flex: 1;
    padding: 10px;
  }

  .add-key-row {
    flex-direction: column;
    gap: 8px;
  }

  .key-input {
    width: 100%;
  }

  .btn-add {
    width: 100%;
  }

  .btn-view-product {
    width: 100%;
    text-align: center;
  }
}

/* Extra small screens */
@media (max-width: 480px) {
  .admin-keys-container {
    padding: 10px;
  }

  .settings-section,
  .products-section {
    padding: 15px;
  }

  .product-card {
    padding: 12px;
  }

  .order-item-card {
    padding: 12px;
  }

  .key-value {
    font-size: 12px;
    word-break: break-all;
    overflow-wrap: break-word;
  }
}

/* Fix potential layout conflicts */
.admin-keys-container .form-group input,
.admin-keys-container .form-group textarea {
  max-width: 100%;
}

.admin-keys-container .btn {
  white-space: nowrap;
  min-width: auto;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Copy key functionality
  document.querySelectorAll('.btn-copy[data-key-value]').forEach(button => {
    button.addEventListener('click', function() {
      const keyValue = this.getAttribute('data-key-value');
      if (!keyValue) return;
      
      // Try modern clipboard API first
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(keyValue).then(() => {
          const originalText = this.textContent;
          const originalBg = this.style.background;
          this.textContent = '‚úÖ';
          this.style.background = '#10b981';
          setTimeout(() => {
            this.textContent = originalText;
            this.style.background = originalBg || '';
          }, 2000);
        }).catch(err => {
          console.error('Failed to copy:', err);
          fallbackCopy(keyValue, this);
        });
      } else {
        // Fallback for older browsers
        fallbackCopy(keyValue, this);
      }
    });
  });

  // Fallback copy method
  function fallbackCopy(text, button) {
    const textArea = document.createElement('textarea');
    textArea.value = text;
    textArea.style.position = 'fixed';
    textArea.style.left = '-999999px';
    textArea.style.top = '-999999px';
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
      const successful = document.execCommand('copy');
      if (successful) {
        const originalText = button.textContent;
        const originalBg = button.style.background;
        button.textContent = '‚úÖ';
        button.style.background = '#10b981';
        setTimeout(() => {
          button.textContent = originalText;
          button.style.background = originalBg || '';
        }, 2000);
      } else {
        alert('Kh√¥ng th·ªÉ sao ch√©p. Vui l√≤ng sao ch√©p th·ªß c√¥ng: ' + text);
      }
    } catch (err) {
      console.error('Fallback copy failed:', err);
      alert('Kh√¥ng th·ªÉ sao ch√©p. Key: ' + text);
    } finally {
      document.body.removeChild(textArea);
    }
  }

  // AJAX form submission for saving keys (no page reload)
  document.querySelectorAll('.add-key-form').forEach(form => {
    const input = form.querySelector('.key-input');
    const button = form.querySelector('.btn-add');
    const productId = form.getAttribute('data-product-id');
    
    if (!input || !button || !productId) return;

    form.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const keyValue = input.value.trim();
      if (!keyValue) {
        input.focus();
        return false;
      }

      // Disable button during request
      const originalButtonText = button.textContent;
      button.disabled = true;
      button.textContent = '‚è≥ ƒêang l∆∞u...';

      try {
        const response = await fetch(`/admin/products/${productId}/key`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ key_value: keyValue })
        });

        const data = await response.json();

        if (data.success) {
          // Show success message
          button.textContent = '‚úÖ ƒê√£ l∆∞u!';
          button.style.background = '#10b981';
          
          // Update the displayed key if it exists
          const keyDisplay = form.closest('.product-key-section').querySelector('.key-display');
          const noKeyMessage = form.closest('.product-key-section').querySelector('.no-key-message');
          
          if (keyDisplay) {
            // Update existing key display
            const keyCode = keyDisplay.querySelector('.key-value');
            if (keyCode) {
              keyCode.textContent = keyValue;
              keyCode.setAttribute('data-key-value', keyValue);
            }
            const copyBtn = keyDisplay.querySelector('.btn-copy');
            if (copyBtn) {
              copyBtn.setAttribute('data-key-value', keyValue);
            }
          } else if (noKeyMessage) {
            // Create new key display
            noKeyMessage.outerHTML = `
              <div class="key-display">
                <div class="key-row">
                  <div class="key-info">
                    <code class="key-value" data-key-value="${keyValue}">${keyValue}</code>
                  </div>
                  <div class="key-actions">
                    <button class="btn-copy" data-key-value="${keyValue}" type="button" title="Sao ch√©p">üìã</button>
                    <form action="/admin/products/${productId}/key/delete?_csrf=<%= csrfToken %>" method="post" style="display:inline;" onsubmit="return confirm('X√≥a key n√†y?')">
                      <button type="submit" class="btn-delete" title="X√≥a key">üóëÔ∏è</button>
                    </form>
                  </div>
                </div>
              </div>
            `;
            // Re-attach copy handler
            const newCopyBtn = form.closest('.product-key-section').querySelector('.btn-copy[data-key-value]');
            if (newCopyBtn) {
              newCopyBtn.addEventListener('click', function() {
                const keyVal = this.getAttribute('data-key-value');
                if (navigator.clipboard && navigator.clipboard.writeText) {
                  navigator.clipboard.writeText(keyVal).then(() => {
                    const originalText = this.textContent;
                    const originalBg = this.style.background;
                    this.textContent = '‚úÖ';
                    this.style.background = '#10b981';
                    setTimeout(() => {
                      this.textContent = originalText;
                      this.style.background = originalBg || '';
                    }, 2000);
                  });
                }
              });
            }
          }

          // Update button text
          button.textContent = '‚úèÔ∏è C·∫≠p nh·∫≠t Key';
          
          setTimeout(() => {
            button.style.background = '';
            button.disabled = false;
          }, 2000);
        } else {
          throw new Error(data.error || 'C√≥ l·ªói x·∫£y ra');
        }
      } catch (error) {
        console.error('Error saving key:', error);
        button.textContent = '‚ùå L·ªói!';
        button.style.background = '#ef4444';
        alert('L·ªói khi l∆∞u key: ' + error.message);
        
        setTimeout(() => {
          button.textContent = originalButtonText;
          button.style.background = '';
          button.disabled = false;
        }, 3000);
      }
    });
  });

  // AJAX delete key
  document.querySelectorAll('form[action*="/key/delete"]').forEach(form => {
    form.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      if (!confirm('X√≥a key n√†y?')) return;

      const actionUrl = form.getAttribute('action');
      const productId = actionUrl.match(/\/products\/(\d+)\/key\/delete/)[1];
      const button = form.querySelector('.btn-delete');
      
      if (button) {
        button.disabled = true;
        button.textContent = '‚è≥';
      }

      try {
        const response = await fetch(`/admin/products/${productId}/key/delete`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          }
        });

        const data = await response.json();

        if (data.success) {
          // Remove key display
          const keyDisplay = form.closest('.product-key-section').querySelector('.key-display');
          if (keyDisplay) {
            keyDisplay.outerHTML = `
              <div class="no-key-message">
                <p>‚ö†Ô∏è S·∫£n ph·∫©m ch∆∞a c√≥ key</p>
              </div>
            `;
          }
          
          // Clear input
          const input = form.closest('.product-key-section').querySelector('.key-input');
          if (input) input.value = '';
          
          // Update button
          const addButton = form.closest('.product-key-section').querySelector('.btn-add');
          if (addButton) addButton.textContent = '‚ûï Th√™m Key';
        } else {
          throw new Error(data.error || 'C√≥ l·ªói x·∫£y ra');
        }
      } catch (error) {
        console.error('Error deleting key:', error);
        alert('L·ªói khi x√≥a key: ' + error.message);
        if (button) {
          button.disabled = false;
          button.textContent = 'üóëÔ∏è';
        }
      }
    });
  });
});
</script>

